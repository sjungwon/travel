<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Title</title>
    <!--    BOOTSTRAP CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <style>
      .hidden {
        display: none;
      }
      .image {
        height: 100%;
        min-height: 100px;
      }
      .preview {
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        width: 100%;
        height: 100%;
        min-height: 100px;
        max-width: 150px;
        max-height: 150px;
        margin: 0 0.5rem;
        padding: 0;
      }
      .preview:first-child {
        margin-left: 0;
      }
      .preview:last-child {
        margin-right: 0;
      }
      .preview-image {
        width: 100%;
        height: 100%;
      }
      .preview-image.default-image {
        width: 50px;
        height: 50px;
      }
      .label-padding {
        padding-right: calc(var(--bs-gutter-x) * 0.5);
        padding-left: calc(var(--bs-gutter-x) * 0.5);
      }
      .row {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h3 class="text-center">아이템 수정</h3>
      </div>
      <div class="row">
        <form
          class="container"
          th:object="${itemUpdateFormDto}"
          enctype="multipart/form-data"
          method="post"
          action="/items/update"
          th:action="@{/items/update}"
        >
          <div class="row">
            <input id="id" th:field="*{id}" type="text" hidden />
          </div>
          <div class="row">
            <label for="category" th:text="#{label.item.category}"
              >카테고리:</label
            >
            <select class="form-select" id="category" th:field="*{category}">
              <option
                th:each="category : ${categories}"
                th:value="${category.getEn()}"
                th:text="${category.getKr()}"
              ></option>
            </select>
          </div>
          <div class="row">
            <label for="title" th:text="#{label.item.title}">이름:</label>
            <input
              id="title"
              class="form-control"
              th:field="*{title}"
              type="text"
            />
          </div>
          <div class="row">
            <label for="itemImage" th:text="#{label.item.image}">사진:</label>
            <div class="container">
              <div class="row image">
                <div
                  class="col preview"
                  th:each="fileName : ${imageStoreFileNames}"
                >
                  <img
                    class="preview-image"
                    src="/item/icon/camera-50.png"
                    th:src="@{{url}/{image} (url=#{src.item.image}, image=${fileName})}"
                  />
                </div>
                <div
                  class="col preview"
                  th:each="num : ${#numbers.sequence(imageStoreFileNames.size(), 3)}"
                >
                  <img
                    class="preview-image default-image"
                    src="/item/icon/camera-50.png"
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <button type="button" class="btn-add btn btn-primary">
              사진 변경
            </button>
            <input
              id="itemImage"
              type="file"
              class="input-file hidden"
              multiple
              th:field="*{itemImages}"
            />
          </div>
          <div class="row">
            <div class="col ps-0">
              <label
                for="zonecode"
                class="label-padding"
                th:text="#{label.item.zonecode}"
                >우편번호:</label
              >
              <input
                id="zonecode"
                class="form-control"
                readonly
                th:field="*{zonecode}"
                type="text"
              />
            </div>
            <div class="col-7 px-0">
              <label
                for="address"
                class="label-padding"
                th:text="#{label.item.address}"
                >주소:</label
              >
              <input
                id="address"
                class="form-control"
                readonly
                th:field="*{address}"
              />
            </div>
            <div class="col-2 pe-0 position-relative">
              <label></label>
              <button
                id="address-search"
                class="btn btn-primary d-block"
                type="button"
              >
                찾기
              </button>
            </div>
          </div>
          <div class="row">
            <label for="address-detail" th:text="#{label.item.addressDetail}"
              >상세 주소:</label
            >
            <input
              id="address-detail"
              class="form-control"
              th:field="*{addressDetail}"
            />
          </div>
          <div class="row">
            <label for="description" th:text="#{label.item.description}"
              >설명:
            </label>
            <textarea id="description" th:field="*{description}"></textarea>
          </div>
          <div class="row">
            <div class="col ps-0">
              <button
                class="btn btn-primary w-100"
                th:text="#{btn.item.update}"
                onclick="return confirm('정말 수정하시겠습니까 ?')"
              >
                수정
              </button>
            </div>
            <div class="col pe-0">
              <a
                class="btn btn-primary w-100"
                th:href="@{/items/{id} (id=${itemUpdateFormDto.id})}"
                onclick="return confirm('정말 취소하시겠습니까?')"
              >
                취소
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script
      src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js"
      referrerpolicy="origin"
    ></script>
    <!-- Bootstrap   -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script>
      //카카오 우편 API
      const zonecode = document.querySelector("#zonecode");
      const address = document.querySelector("#address");
      const postFunc = (event) => {
        // console.log("click");
        new daum.Postcode({
          oncomplete: function (data) {
            zonecode.setAttribute("value", data.zonecode);
            address.setAttribute("value", data.address);
            // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분입니다.
            // 예제를 참고하여 다양한 활용법을 확인해 보세요.
          },
        }).open();
      };
      const btnEl = document.querySelector("#address-search");
      btnEl.addEventListener("click", postFunc);

      //wysiwyg - TinyMCE
      tinymce.init({
        selector: "#description",
      });

      //사진 파일 관리
      let files = null;
      const addBtn = document.querySelector(".btn-add");
      const fileInput = document.querySelector(".input-file");
      addBtn.addEventListener("click", () => {
        // console.log(fileInput);
        fileInput.click();
      });

      const DEFAULT_URL = "/item/icon/camera-50.png";
      const setImageFunc = (fileList) => {
        const imageDivEl = document.querySelector(".image");
        // console.log(imageDivEl.children);
        const prevDivEl = Array.from(imageDivEl.children).filter((c) => {
          return c.tagName === "DIV";
        });
        // console.log(prevDivEl);
        prevDivEl.forEach((c, i) => {
          const imgEl = c.firstElementChild;
          if (i < fileList.length) {
            imgEl.setAttribute("src", URL.createObjectURL(fileList[i]));
            imgEl.classList.remove("default-image");
          } else {
            imgEl.setAttribute("src", DEFAULT_URL);
            imgEl.classList.add("default-image");
          }
        });
      };

      fileInput.addEventListener("input", (event) => {
        const newfiles = event.target.files;
        if (!!newfiles && newfiles.length > 4) {
          files = Array.from(newfiles).slice(0, 5);
          window.alert("사진은 4개까지 등록됩니다.");
        } else {
          files = Array.from(newfiles);
        }
        setImageFunc(files);
        // console.log(URL.createObjectURL(files[0]));
      });
    </script>
  </body>
</html>
